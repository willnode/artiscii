function CanvasState(e,t,o){this.data=e,this.area=t,this.selection=o,this.equals=function(e){return e.data===this.data&&e.area===this.area&&e.selection===this.selection}}function IsBlank(e){return e<=32}function getLineChar(e,t){if(void 0===e&&void 0===t||e===t)return"+";void 0!==t&&(e=(180*Math.atan2(t.y-e.y,t.x-e.x)/Math.PI+360)%360);var o=e;return o<22.5?"-":o<67.5?"\\":o<112.5?"|":o<157.5?"/":o<202.5?"-":o<247.5?"\\":o<295.5?"|":o<337.5?"/":"-"}function ellipsePerimeter(e,t){return Math.PI*(3*(e+t)-Math.sqrt((3*e+t)*(e+3*t)))}function makeState(e){return!0===e?e=new Rect(0,0,size.x,size.y):!1===e&&(e=selection),new CanvasState(charsat(e),e.clone(),selection.clone())}function ApplyState(e){_freeze=!0,charsat(e.area,e.data),_freeze=!1,sels(e.selection)}function systemcopy(e){var t=document.createElement("textarea");t.setAttribute("style","width:1px;border:0;opacity:0;"),document.body.appendChild(t),t.value=e,t.select(),document.execCommand("copy"),document.body.removeChild(t)}for(var heads=["Select","Freetype","Dragdrop","Brush","Line","Rectangle","Circle"],Tool=Object.freeze({Select:0,Freetype:1,Dragdrop:2,Brush:3,Line:4,Rectangle:5,Circle:6}),_hdd=$("#heads"),i=0;i<heads.length;i++)_hdd.append("<input type='radio' name='tool' id='"+heads[i]+"' "+(0==i?"checked":"")+">"),_hdd.append("<label for='"+heads[i]+"'>"+heads[i]+"</label>");$("input[name=tool]").on("click",function(){head(head())});var head=function(e){if(void 0===e)return heads.indexOf($("input[name='tool']:checked").get(0).id);$("#"+heads[e]).prop("checked",!0),showcursor("default");var t=window.scrollX,o=window.scrollY;canvas.focus(),window.scrollTo(t,o),_headback=void 0,RecordUndo(),redraw()},Point=function(e,t){this.x=e,this.y=t};Point.prototype.clone=function(){return new Point(this.x,this.y)},Point.prototype.equals=function(e){return this.x===e.x&&this.y===e.y},Point.prototype.trunc=function(){this.x=Math.trunc(this.x+.5),this.y=Math.trunc(this.y+.5)};var Rect=function(e,t,o,a){this.x=e,this.y=t,this.w=o,this.h=a,this.r=e+o,this.b=t+a};Rect.prototype.clone=function(){return new Rect(this.x,this.y,this.w,this.h)},Rect.prototype.location=function(){return new Point(this.x,this.y)},Rect.prototype.size=function(){return new Point(this.w,this.h)},Rect.prototype.equals=function(e){return this.x===e.x&&this.y===e.y&&this.w===e.w&&this.h===e.h},Rect.prototype.isContaining=function(e){return this.x<=e.x&&e.x<=this.r&&this.y<=e.y&&e.y<=this.b},Rect.prototype.trunc=function(){this.x=Math.trunc(this.x),this.y=Math.trunc(this.y),this.w=Math.trunc(this.w),this.h=Math.trunc(this.h),this.r=this.x+this.w,this.b=this.y+this.h};var thisname="artiscii",Key=Object.freeze({Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Pause:19,Caps_Lock:20,Escape:27,Space:32,Page_Up:33,Page_Down:34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,Alpha0:48,Alpha1:49,Alpha2:50,Alpha3:51,Alpha4:52,Alpha5:53,Alpha6:54,Alpha7:55,Alpha8:56,Alpha9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,Left_Meta:91,Right_Meta:92,Select:93,Numpad_0:96,Numpad_1:97,Numpad_2:98,Numpad_3:99,Numpad_4:100,Numpad_5:101,Numpad_6:102,Numpad_7:103,Numpad_8:104,Numpad_9:105,Multiply:106,Add:107,Subtract:109,Decimal:110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,Num_Lock:144,Scroll_Lock:145,Semicolon:186,Equals:187,Comma:188,Dash:189,Period:190,Forward_Slash:191,Grave_Accent:192,Open_Bracket:219,Back_Slash:220,Close_Bracket:221,Single_Quote:222}),fill=function(e,t,o){void 0===t&&(t=size.x),void 0===o&&(o=size.y);for(var a="",n=t*o,r=0;r<e.length&&!(a.length>=n);r++){var s=e.charAt(r);if("\r"!==s)if("\n"===s)for(;a.length%t!=0;)a+=" ";else a+=s.charCodeAt(0)<=32?" ":s}for(;a.length<n;)a+=" ";return a},showcursor=function(e){if(void 0===e)return canvas.style.cursor;canvas.style.cursor=e},_pltte=$("#palette"),pals=function(e){if(void 0===e)return palette;palette=1===e.length?e.charAt(0):"\0",_pltte.text("\0"===palette?"''":"'"+palette+"'"),redraw()},text=function(e){if(void 0===e)return data;data=fill(e),redraw()},curs=function(e){if(void 0===e)return cursor;cursor=e,redraw()},sels=function(e){if(void 0===e)return selection;e.trunc(),selection=void 0!==e.w&&void 0!==e.h?e:new Rect(e.x,e.y,selection.w,selection.h),redraw()},charat=function(e,t){e.trunc();var o=e.y*size.x+e.x;return o>data.length?"\0":void 0===t?data.charAt(o):(data=data.substring(0,o)+t.charAt(0)+data.substring(o+1),void redraw())},charsat=function(e,t){if(e.trunc(),void 0===t){for(var o="",a=e.y;a<e.b;a++)o+=data.substr(a*size.x+e.x,e.w);return o}if(t.length!=e.w*e.h)throw"unmatching buffer count!";for(a=e.y;a<e.b;a++)data=data.substring(0,a*size.x+e.x)+t.substr((a-e.y)*e.w,e.w)+data.substring(a*size.x+e.r);redraw()},restat=function(){var e="● ("+_mouse.x+", "+_mouse.y+") ";head()===Tool.Freetype&&(e+="● ("+cursor.x+", "+cursor.y+") "),e+="□ ("+selection.x+", "+selection.y+") ",isCursorFree()||(e+="◇ ("+selection.w+", "+selection.h+") "),foot.text(e)},redraw=function(){if(!_freeze){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.fillStyle="#07c",ctx.fillRect(selection.x*width,selection.y*height,selection.w*width,selection.h*height),ctx.fillStyle="#ef2",head()==Tool.Freetype&&ctx.fillRect(cursor.x*width,cursor.y*height,width,height),ctx.textBaseline="top",ctx.font=font,ctx.fillStyle="black";for(var e=0;e<size.y;e++)ctx.fillText(data.substr(e*size.x,size.x),0,e*height)}},resizeCanvas=function(){canvas.width=size.x*width,canvas.height=size.y*height,redraw(),localStorage.setItem(thisname+"-size",JSON.stringify({x:size.x,y:size.y,px:height}))},resizeCell=function(e){size=e,data=fill(data),resizeCanvas()},resizeFont=function(e){font=(height=e)+"px Courier New, Courier, monospace",ctx.font=font,width=ctx.measureText(" ").width,resizeCanvas()},getMousePos=function(e){var t=canvas.getBoundingClientRect();return new Point(e.clientX-t.left,e.clientY-t.top)},flexible=function(e){return e.w<0&&(e.x+=e.w,e.w*=-1),e.h<0&&(e.y+=e.h,e.h*=-1),e.w++,e.h++,e},copy=function(e){(e=e||selection).trunc();for(var t="",o=e.y;o<e.b;o++)t+=data.substr(o*size.x+e.x,e.w)+"\n";return t},paste=function(e,t){if(e=e.replace("\r","")){if(isCursorFree()){for(var o=selection,a=0,n=0,r=0;r<e.length;r++)"\n"===e.charAt(r)?(o.w=Math.max(o.w,a),n++,a=0):a++;o.h=Math.min(size.y-o.y,n+1),selection=o}charsat(selection,fill(e,selection.w,selection.h))}else clearSelected()},append=function(e){return"\n"===e?(gotoNextLine(),!0):(charat(cursor,e),gotoRight())},gotoUp=function(){var e=cursor;isCursorFree()?0==e.y&&(e.y=size.y):e.y==selection.y&&(e.y=selection.b),e.y--,redraw()},gotoDown=function(){var e=cursor;e.y++,isCursorFree()?e.y==size.y&&(e.y=0):e.y==selection.b&&(e.y=selection.y),redraw()},gotoRight=function(){var e=cursor;e.x++,isCursorFree()?e.x==size.x&&(e.x=0,e.y++,e.y==size.y&&(e.y=0)):e.x==selection.r&&(e.x=selection.x,e.y++,e.y==selection.b&&(e.y=selection.y));var t=e.y!=cursor.y;return redraw(),t},gotoLeft=function(){var e=cursor;isCursorFree()?0==e.x&&(0==e.y&&(e.y=size.y),e.y--,e.x=size.x):e.x==selection.x&&(e.y==selection.y&&(e.y=selection.b),e.y--,e.x=selection.r),e.x--;var t=e.y!==cursor.y;return redraw(),t},gotoNextLine=function(){var e=cursor;isCursorFree()?(e.x=0,e.y=(e.y+1)%size.y):(e.x=selection.x,e.y=(e.y-selection.y+1)%selection.h+selection.y),redraw()},clearSelected=function(){charsat(selection," ".repeat(selection.w*selection.h))},MoveSelected=function(e){if(!selection.location().equals(e)){var t=charsat(selection);_freeze=!0,clearSelected(),sels(e),_freeze=!1,charsat(selection,t)}},Backspace=function(e){if(e){var t=charsat(selection),o=cursor.x-selection.x+(cursor.y-selection.y)*selection.w;t=" "+t.substr(0,o-1),charsat(selection,t)}else gotoLeft(),charat(cursor," ")},Delete=function(e){if(e){var t=charsat(selection),o=cursor.x-selection.x+(cursor.y-selection.y)*selection.w;t=t.substr(0,o)+t.substr(o+1,t.length-o-1)+" ",charsat(selection,t)}else charat(cursor," "),gotoRight()},Insert=function(e){if(e){var t=charsat(selection),o=cursor.x-selection.x+(cursor.y-selection.y)*selection.w;Array.copy(t,1,t,0,o-1),t[t.length-1]=" ",charsat(selection,t)}else{var t=charsat(selection),o=cursor.x-selection.x+(cursor.y-selection.y)*selection.w;Array.copy(t,o,t,o+1,t.length-o-1),t[o]=" ",charsat(selection,t)}},isCursorFree=function(){return selection.w<=1&&selection.h<=1},RecordUndo=function(e){void 0===e&&(e=makeState(!0)),undostack.length>0&&undostack[undostack.length-1].equals(e)||(undostack.push(e),undostack.length>20&&undostack.shift(),localStorage.setItem(thisname,JSON.stringify(e)))},Undo=function(){if(undostack.length>0){var e=data,t=selection;ApplyState(undostack.pop()),undostack.length>0&&data==e&&selection.equals(t)&&Undo()}},drawLine=function(e,t){if(e.equals(t))charat(e,"\0"==palette?getLineChar():palette);else for(var o=new Point(0,0),a=new Point(0,0),n=new Point(e.x-t.x,e.y-t.y),r=Math.trunc(Math.sqrt(n.x*n.x+n.y*n.y))+1,s=0;s<=r;){o.x=e.x+(t.x-e.x)*s/r,o.y=e.y+(t.y-e.y)*s/r;do{s++,a.x=e.x+(t.x-e.x)*s/r,a.y=e.y+(t.y-e.y)*s/r}while(o.equals(a));charat(o,"\0"==palette?getLineChar(o,a):palette)}},drawRectangle=function(e,t){if(e.equals(t))charat(e,"\0"==palette?getLineChar():palette);else{drawLine(new Point(e.x,e.y),new Point(t.x,e.y)),drawLine(new Point(e.x,t.y),new Point(t.x,t.y)),drawLine(new Point(e.x,e.y),new Point(e.x,t.y)),drawLine(new Point(t.x,e.y),new Point(t.x,t.y));var o="\0"==palette?getLineChar():palette;charat(e,o),charat(t,o),charat(new Point(e.x,t.y),o),charat(new Point(t.x,e.y),o)}},drawEllipse=function(e,t){if(e.equals(t))charat(e,"\0"==palette?getLineChar():palette);else{var o=(e.x-t.x)/2,a=(e.y-t.y)/2,n=t.x,r=t.y;o<0&&(n+=2*o,o=Math.abs(o)),a<0&&(r+=2*a,a=Math.abs(a)),n+=o,r+=a;for(var s=0,i=a,c=o*o,l=a*a,h=-(c/4+o%2+l),d=-(l/4+a%2+c),u=-(l/4+a%2),y=-c*i,w=2*l*s,x=-2*c*i,f=2*l,p=2*c,g=function(){s++,y+=w+=f},v=function(){i--,y+=x+=p};i>=0&&s<=o;){var _="\0"===palette?getLineChar():palette;charat(new Point(n+s,r+i),_),0==s&&0==i||charat(new Point(n-s,r-i),_),0!=s&&0!=i&&(charat(new Point(n+s,r-i),_),charat(new Point(n-s,r+i),_)),y+l*s<=h||y+c*i<=u?g():y-c*i>d?v():(g(),v())}for(var z,b,k=new Point(e.x-t.x,e.y-t.y),m=new Point((e.x+t.x)/2,(e.y+t.y)/2),P=ellipsePerimeter(k.x,k.y),C=0;C<=P;){z=new Point(m.x+Math.trunc(Math.cos(C/P*2*Math.PI)*k.x/2),m.y+Math.trunc(Math.sin(C/P*2*Math.PI)*k.y/2));do{C++,b=new Point(m.x+Math.trunc(Math.cos(C/P*2*Math.PI)*k.x/2),m.y+Math.trunc(Math.sin(C/P*2*Math.PI)*k.y/2))}while(z==b&&C<=P);charat(z,"\0"==palette?getLineChar(z,b):palette)}}},canvas=$("#canvas").get(0),ctx=canvas.getContext("2d"),foot=$("#status"),height,width,font,_headback,_seldown,_drgdown,_drwshot,_dwned,_freeze,_mouse=new Point(0,0),size=new Point(100,30),selection=new Rect(0,0,1,1),cursor=new Point(0,0),data=fill(""),undostack=[],palette="\0";$(canvas).on("mousedown",function(e){if(1===e.which){var t=getMousePos(e),o=head();_seldown=_mouse=new Point(Math.floor(t.x/width),Math.floor(t.y/height)),o===Tool.Line||o===Tool.Rectangle||o===Tool.Circle?_drwshot=data:o===Tool.Dragdrop||e.ctrlKey?(head(Tool.Dragdrop),_headback=Tool.Select,_drgdown=selection.clone(),showcursor("move")):o===Tool.Freetype?_headback!==Tool.Select||selection.isContaining(_seldown)?curs(_seldown.clone()):head(Tool.Select):(sels(new Rect(_seldown.x,_seldown.y,1,1)),o===Tool.Brush&&charat(selection.location(),"\0"===palette?" ":palette)),_dwned=!0,restat()}}),$(document).on("mousemove",function(e){var t=getMousePos(e);if(t.x=Math.trunc(t.x/width),t.y=Math.trunc(t.y/height),_mouse=t,restat(),_dwned)switch(head()){case Tool.Select:sels(flexible(new Rect(_seldown.x,_seldown.y,t.x-_seldown.x,t.y-_seldown.y)));break;case Tool.Freetype:break;case Tool.Dragdrop:sels(new Point(t.x-_seldown.x+_drgdown.x,t.y-_seldown.y+_drgdown.y));break;case Tool.Brush:sels(new Rect(t.x,t.y,1,1)),charat(selection.location(),"\0"===palette?" ":palette);break;case Tool.Line:case Tool.Rectangle:case Tool.Circle:switch(sels(flexible(new Rect(_seldown.x,_seldown.y,t.x-_seldown.x,t.y-_seldown.y))),_freeze=!0,data=_drwshot,head()){case Tool.Line:drawLine(t,_seldown);break;case Tool.Rectangle:drawRectangle(t,_seldown);break;case Tool.Circle:drawEllipse(t,_seldown)}_freeze=!1,redraw()}}),$(document).on("mouseup",function(e){if(_dwned&&(_dwned=!1,head()===Tool.Dragdrop)){var t=getMousePos(e);t.x=Math.trunc(t.x/width),t.y=Math.trunc(t.y/height),restat(),sels(_drgdown),MoveSelected(new Point(t.x-_seldown.x+_drgdown.x,t.y-_seldown.y+_drgdown.y)),_headback==Tool.Select&&(head(Tool.Select),showcursor("default"))}}),$(canvas).on("keydown",function(e){var t=head();if(e.keyCode===Key.Delete&&t!==Tool.Freetype)return clearSelected(),void e.preventDefault();if(e.ctrlKey){switch(e.keyCode){case Key.A:sels(new Rect(0,0,size.x,size.y));break;case Key.C:systemcopy(copy());break;case Key.Z:Undo();break;default:return}return e.preventDefault(),!0}if(t===Tool.Select&&(head(t=Tool.Freetype),_headback=Tool.Select,curs(selection.location()),showcursor("text"),RecordUndo()),t>=Tool.Brush)e.key.length>=1&&(pals(e.key),e.preventDefault());else if(t==Tool.Freetype){switch(e.keyCode){case Key.Enter:_headback===Tool.Select?isCursorFree()?(gotoDown(),selection=new Rect(selection.x,cursor.y,1,1),head(Tool.Select)):cursor.y===selection.b-1?head(Tool.Select):gotoNextLine():gotoNextLine();break;case Key.Backspace:Backspace(e.shiftKey);break;case Key.Delete:Delete(!e.shiftKey);break;case Key.Insert:Insert(e.shiftKey);break;case Key.Up:gotoUp();break;case Key.Down:gotoDown();break;case Key.Right:gotoRight();break;case Key.Left:gotoLeft();break;default:if(1!==e.key.length)return;append(e.key)}e.preventDefault()}restat()}),$("#resize-ok").on("click",function(){resizeCell({x:~~$("#resize-x").val(),y:~~$("#resize-y").val()}),resizeFont(~~$("#resize-px").val())});var statesize=localStorage.getItem(thisname+"-size");statesize?(statesize=JSON.parse(statesize),$("#resize-x").val(statesize.x),$("#resize-y").val(statesize.y),$("#resize-px").val(statesize.px),resizeCell(new Point(statesize.x,statesize.y)),resizeFont(statesize.px)):resizeFont(12);var state=localStorage.getItem(thisname);if(state){RecordUndo();var x=JSON.parse(state);ApplyState(new CanvasState(x.data,new Rect(x.area.x,x.area.y,x.area.w,x.area.h),new Rect(x.selection.x,x.selection.y,x.selection.w,x.selection.h)))}$(window).bind("beforeunload",function(){RecordUndo()}),document.addEventListener("paste",function(e){e.clipboardData&&paste(e.clipboardData.getData("text/plain"))});